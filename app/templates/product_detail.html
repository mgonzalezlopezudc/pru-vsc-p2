{% extends "base.html" %}

{% block title %}{{ t('product.title', name=product.name) }}{% endblock %}

{% block content %}
<section class="card hero-media">
  <div class="hero-image-wrap square">
    <img class="hero-image" src="{{ product.image }}" alt="{{ product.name }}" loading="lazy" data-fallback="{{ url_for('static', filename='images/product-placeholder.svg') }}" onerror="this.onerror=null;this.src=this.dataset.fallback;">
  </div>
  <div>
    <p class="eyebrow">{{ t('product.eyebrow') }}</p>
    <h2>{{ product.name }}</h2>
    <p>{{ t('product.size') }}: <strong>{{ product.size }}</strong></p>
    <p>{{ t('product.price') }}: <strong>{{ product.price|currency }}</strong></p>
  </div>
</section>

<section class="card form-block">
  <h3>{{ t('form.product_edit') }}</h3>
  <form method="post" action="{{ url_for('main.update_product', product_id=product.id, lang=current_lang) }}" class="inline-form">
    {{ product_edit_form.hidden_tag() }}
    <label>{{ t('field.name') }}<input type="text" name="{{ product_edit_form.name.name }}" value="{{ product_edit_form.name.data }}" required maxlength="120"></label>
    <label>{{ t('field.size') }}<input type="text" name="{{ product_edit_form.size.name }}" value="{{ product_edit_form.size.data }}" required maxlength="24"></label>
    <label>{{ t('field.price') }}<input type="number" name="{{ product_edit_form.price.name }}" value="{{ product_edit_form.price.data }}" min="0" required></label>
    <label>{{ t('field.image') }}<input type="url" name="{{ product_edit_form.image.name }}" value="{{ product_edit_form.image.data }}" required maxlength="400"></label>
    <button type="submit" class="btn">{{ t('action.save') }}</button>
  </form>
  <form method="post" class="compact-form" action="{{ url_for('main.delete_product', product_id=product.id, lang=current_lang) }}">
    {{ delete_form.hidden_tag() }}
    <button type="submit" class="btn btn-danger">{{ t('action.delete_product') }}</button>
  </form>
</section>

<section class="card">
  <h3>{{ t('product.availability') }}</h3>
  <table>
    <thead>
      <tr>
        <th>{{ t('table.store') }}</th>
        <th>{{ t('table.shelf') }}</th>
        <th>{{ t('table.stock_total') }}</th>
        <th>{{ t('table.on_shelf') }}</th>
        <th>{{ t('table.actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for row in inventory %}
      <tr>
        <td>
          <a href="{{ url_for('main.store_detail', store_id=row.storeId) }}">{{ row.storeName }}</a>
        </td>
        <td>
          <a href="{{ url_for('main.store_detail', store_id=row.storeId, lang=current_lang, edit_shelf_id=row.shelfId) }}">{{ row.shelfName }}</a>
        </td>
        <td>{{ row.stockCount }}</td>
        <td>{{ row.shelfCount }}</td>
        <td class="actions-cell">
          <div class="action-group">
            <a class="btn btn-secondary" href="{{ url_for('main.product_detail', product_id=product.id, lang=current_lang, edit_item_id=row.id) }}">{{ t('action.edit') }}</a>
            <form method="post" class="compact-form" action="{{ url_for('main.delete_product_inventory_item', product_id=product.id, item_id=row.id, lang=current_lang) }}">
              {{ delete_form.hidden_tag() }}
              <button type="submit" class="btn btn-danger">{{ t('action.delete') }}</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="form-block">
    <h4>{{ t('form.inventory_create') }}</h4>
    <form method="post" action="{{ url_for('main.create_product_inventory_item', product_id=product.id, lang=current_lang) }}" class="inline-form" data-validate="inventory">
      {{ inventory_create_form.hidden_tag() }}
      <input type="hidden" name="{{ inventory_create_form.product_id.name }}" value="{{ product.id }}">
      <label>
        {{ t('table.store') }}
        <select name="{{ inventory_create_form.store_id.name }}" required>
          {% for store in stores %}
          <option value="{{ store.id }}">{{ store.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        {{ t('table.shelf') }}
        <select name="{{ inventory_create_form.shelf_id.name }}" required>
          {% for shelf in shelves %}
          <option value="{{ shelf.id }}">{{ shelf.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        {{ t('table.stock_total') }}
        <input type="number" name="{{ inventory_create_form.stock_count.name }}" min="0" required>
      </label>
      <label>
        {{ t('table.on_shelf') }}
        <input type="number" name="{{ inventory_create_form.shelf_count.name }}" min="0" required>
      </label>
      <button type="submit" class="btn">{{ t('action.create') }}</button>
    </form>
  </div>

  {% if selected_item and inventory_edit_form %}
  <div class="form-block">
    <h4>{{ t('form.inventory_edit') }}</h4>
    <form method="post" action="{{ url_for('main.update_product_inventory_item', product_id=product.id, item_id=selected_item.id, lang=current_lang) }}" class="inline-form" data-validate="inventory">
      {{ inventory_edit_form.hidden_tag() }}
      <label>
        {{ t('table.stock_total') }}
        <input type="number" name="{{ inventory_edit_form.stock_count.name }}" value="{{ inventory_edit_form.stock_count.data }}" min="0" required>
      </label>
      <label>
        {{ t('table.on_shelf') }}
        <input type="number" name="{{ inventory_edit_form.shelf_count.name }}" value="{{ inventory_edit_form.shelf_count.data }}" min="0" required>
      </label>
      <button type="submit" class="btn">{{ t('action.save') }}</button>
      <a class="btn btn-secondary" href="{{ url_for('main.product_detail', product_id=product.id, lang=current_lang) }}">{{ t('action.cancel') }}</a>
    </form>
  </div>
  {% endif %}
</section>
{% endblock %}
