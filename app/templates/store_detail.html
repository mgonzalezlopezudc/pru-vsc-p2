{% extends "base.html" %}

{% block title %}{{ t('store.title', name=store.name) }}{% endblock %}

{% block content %}
<section class="app-card mb-5 grid gap-5 lg:grid-cols-[280px_1fr]">
  <div class="overflow-hidden rounded-xl bg-slate-100">
    <img class="h-56 w-full object-cover" src="{{ store.image }}" alt="{{ store.name }}" loading="lazy" data-fallback="{{ url_for('static', filename='images/store-placeholder.svg') }}" onerror="this.onerror=null;this.src=this.dataset.fallback;">
  </div>
  <div>
    <p class="text-xs font-semibold uppercase tracking-wider text-brand-700">{{ t('store.eyebrow') }}</p>
    <h2 class="mt-1 text-2xl font-bold text-slate-900">{{ store.name }}</h2>
    <p class="mt-2 text-slate-600">{{ store.address }}</p>
  </div>
</section>

<section class="app-card mb-5">
  <h3 class="mb-4 text-lg font-semibold">{{ t('form.store_edit') }}</h3>
  <form method="post" action="{{ url_for('main.update_store', store_id=store.id, lang=current_lang) }}" class="grid gap-3 md:grid-cols-2 xl:grid-cols-5">
    {{ store_edit_form.hidden_tag() }}
    <label class="app-label">{{ t('field.name') }}<input class="app-input" type="text" name="{{ store_edit_form.name.name }}" value="{{ store_edit_form.name.data }}" required maxlength="120"></label>
    <label class="app-label">{{ t('field.address') }}<input class="app-input" type="text" name="{{ store_edit_form.address.name }}" value="{{ store_edit_form.address.data }}" required maxlength="240"></label>
    <label class="app-label">{{ t('field.image') }}<input class="app-input" type="url" name="{{ store_edit_form.image.name }}" value="{{ store_edit_form.image.data }}" required maxlength="400"></label>
    <label class="app-label">{{ t('field.latitude') }}<input class="app-input" type="number" step="any" name="{{ store_edit_form.latitude.name }}" value="{{ store_edit_form.latitude.data }}" required></label>
    <label class="app-label">{{ t('field.longitude') }}<input class="app-input" type="number" step="any" name="{{ store_edit_form.longitude.name }}" value="{{ store_edit_form.longitude.data }}" required></label>
    <div class="md:col-span-2 xl:col-span-5">
      <button type="submit" class="app-btn">{{ t('action.save') }}</button>
    </div>
  </form>
  <form method="post" class="mt-3 inline-flex" action="{{ url_for('main.delete_store', store_id=store.id, lang=current_lang) }}">
    {{ delete_form.hidden_tag() }}
    <button type="submit" class="app-btn-danger">{{ t('action.delete_store') }}</button>
  </form>
</section>

<section class="app-card mb-5">
  <h3 class="mb-3 text-lg font-semibold">{{ t('store.location') }}</h3>
  <div id="store-map" class="map" data-geojson='{{ store.location|tojson }}'></div>
</section>

<section class="app-card mb-5">
  <h3 class="mb-3 text-lg font-semibold">{{ t('store.shelves') }}</h3>
  <div class="app-table-wrap">
  <table class="app-table">
    <thead>
      <tr>
        <th>{{ t('table.name') }}</th>
        <th>{{ t('table.current_load') }}</th>
        <th>{{ t('table.max_capacity') }}</th>
        <th>{{ t('table.actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for shelf in shelves %}
      <tr>
        <td>
          <a class="font-medium text-brand-700 hover:text-brand-800" href="{{ url_for('main.store_detail', store_id=store.id, lang=current_lang, edit_shelf_id=shelf.id) }}">{{ shelf.name }}</a>
        </td>
        <td>{{ shelf.currentLoad }}</td>
        <td>{{ shelf.maxCapacity }}</td>
        <td class="whitespace-nowrap">
          <div class="inline-flex gap-2">
            <form method="post" class="inline-flex" action="{{ url_for('main.delete_shelf', store_id=store.id, shelf_id=shelf.id, lang=current_lang) }}">
              {{ delete_form.hidden_tag() }}
              <button type="submit" class="app-btn-danger">{{ t('action.delete') }}</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <div class="mt-5 border-t border-slate-200 pt-4">
    <h4 class="mb-3 font-semibold">{{ t('form.shelf_create') }}</h4>
    <form method="post" action="{{ url_for('main.create_shelf', store_id=store.id, lang=current_lang) }}" class="grid gap-3 md:grid-cols-3">
      {{ shelf_create_form.hidden_tag() }}
      <label class="app-label">
        {{ t('table.name') }}
        <input class="app-input" type="text" name="{{ shelf_create_form.name.name }}" maxlength="120" required>
      </label>
      <label class="app-label">
        {{ t('table.max_capacity') }}
        <input class="app-input" type="number" name="{{ shelf_create_form.max_capacity.name }}" min="0" required>
      </label>
      <div class="flex items-end">
        <button type="submit" class="app-btn">{{ t('action.create') }}</button>
      </div>
    </form>
  </div>

  {% if selected_shelf and shelf_edit_form %}
  <div class="mt-5 border-t border-slate-200 pt-4">
    <h4 class="mb-3 font-semibold">{{ t('form.shelf_edit', name=selected_shelf.name) }}</h4>
    <form method="post" action="{{ url_for('main.update_shelf', store_id=store.id, shelf_id=selected_shelf.id, lang=current_lang) }}" class="grid gap-3 md:grid-cols-3">
      {{ shelf_edit_form.hidden_tag() }}
      <label class="app-label">
        {{ t('table.name') }}
        <input class="app-input" type="text" name="{{ shelf_edit_form.name.name }}" value="{{ shelf_edit_form.name.data }}" maxlength="120" required>
      </label>
      <label class="app-label">
        {{ t('table.max_capacity') }}
        <input class="app-input" type="number" name="{{ shelf_edit_form.max_capacity.name }}" value="{{ shelf_edit_form.max_capacity.data }}" min="0" required>
      </label>
      <div class="flex items-end gap-2">
        <button type="submit" class="app-btn">{{ t('action.save') }}</button>
        <a class="app-btn-secondary" href="{{ url_for('main.store_detail', store_id=store.id, lang=current_lang) }}">{{ t('action.cancel') }}</a>
      </div>
    </form>
  </div>
  {% endif %}
</section>

<section class="app-card">
  <h3 class="mb-3 text-lg font-semibold">{{ t('store.inventory') }}</h3>
  <div class="app-table-wrap">
  <table class="app-table">
    <thead>
      <tr>
        <th>{{ t('table.product') }}</th>
        <th>{{ t('table.shelf') }}</th>
        <th>{{ t('table.stock_total') }}</th>
        <th>{{ t('table.on_shelf') }}</th>
        <th>{{ t('table.actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for row in inventory %}
      <tr>
        <td>
          <a class="font-medium text-brand-700 hover:text-brand-800" href="{{ url_for('main.product_detail', product_id=row.productId) }}">{{ row.productName }}</a>
          <div class="text-xs text-slate-500">{{ row.productSize }} Â· {{ row.productPrice|currency }}</div>
        </td>
        <td>
          <a class="font-medium text-brand-700 hover:text-brand-800" href="{{ url_for('main.store_detail', store_id=store.id, lang=current_lang, edit_shelf_id=row.shelfId) }}">{{ row.shelfName }}</a>
        </td>
        <td>{{ row.stockCount }}</td>
        <td>{{ row.shelfCount }}</td>
        <td class="whitespace-nowrap">
          <div class="inline-flex gap-2">
            <a class="app-btn-secondary" href="{{ url_for('main.store_detail', store_id=store.id, lang=current_lang, edit_item_id=row.id) }}">{{ t('action.edit') }}</a>
            <form method="post" class="inline-flex" action="{{ url_for('main.delete_store_inventory_item', store_id=store.id, item_id=row.id, lang=current_lang) }}">
              {{ delete_form.hidden_tag() }}
              <button type="submit" class="app-btn-danger">{{ t('action.delete') }}</button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <div class="mt-5 border-t border-slate-200 pt-4">
    <h4 class="mb-3 font-semibold">{{ t('form.inventory_create') }}</h4>
    <form method="post" action="{{ url_for('main.create_store_inventory_item', store_id=store.id, lang=current_lang) }}" class="grid gap-3 md:grid-cols-2 xl:grid-cols-5" data-validate="inventory">
      {{ inventory_create_form.hidden_tag() }}
      <input type="hidden" name="{{ inventory_create_form.store_id.name }}" value="{{ store.id }}">
      <label class="app-label">
        {{ t('table.shelf') }}
        <select class="app-input" name="{{ inventory_create_form.shelf_id.name }}" required>
          {% for shelf in shelves %}
          <option value="{{ shelf.id }}">{{ shelf.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="app-label">
        {{ t('table.product') }}
        <select class="app-input" name="{{ inventory_create_form.product_id.name }}" required>
          {% for product in products %}
          <option value="{{ product.id }}">{{ product.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="app-label">
        {{ t('table.stock_total') }}
        <input class="app-input" type="number" name="{{ inventory_create_form.stock_count.name }}" min="0" required>
      </label>
      <label class="app-label">
        {{ t('table.on_shelf') }}
        <input class="app-input" type="number" name="{{ inventory_create_form.shelf_count.name }}" min="0" required>
      </label>
      <div class="flex items-end">
        <button type="submit" class="app-btn">{{ t('action.create') }}</button>
      </div>
    </form>
  </div>

  {% if selected_item and inventory_edit_form %}
  <div class="mt-5 border-t border-slate-200 pt-4">
    <h4 class="mb-3 font-semibold">{{ t('form.inventory_edit') }}</h4>
    <form method="post" action="{{ url_for('main.update_store_inventory_item', store_id=store.id, item_id=selected_item.id, lang=current_lang) }}" class="grid gap-3 md:grid-cols-3" data-validate="inventory">
      {{ inventory_edit_form.hidden_tag() }}
      <label class="app-label">
        {{ t('table.stock_total') }}
        <input class="app-input" type="number" name="{{ inventory_edit_form.stock_count.name }}" value="{{ inventory_edit_form.stock_count.data }}" min="0" required>
      </label>
      <label class="app-label">
        {{ t('table.on_shelf') }}
        <input class="app-input" type="number" name="{{ inventory_edit_form.shelf_count.name }}" value="{{ inventory_edit_form.shelf_count.data }}" min="0" required>
      </label>
      <div class="flex items-end gap-2">
        <button type="submit" class="app-btn">{{ t('action.save') }}</button>
        <a class="app-btn-secondary" href="{{ url_for('main.store_detail', store_id=store.id, lang=current_lang) }}">{{ t('action.cancel') }}</a>
      </div>
    </form>
  </div>
  {% endif %}
</section>
{% endblock %}
